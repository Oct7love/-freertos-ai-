# FreeRTOS智能安全帽项目进度

> 更新：2026-01-06 | STM32F103 + FreeRTOS + ESP32-S3 小智AI

---

## 项目架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        智能安全帽系统                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐              ┌─────────────────────────┐  │
│  │   STM32F103     │    UART      │      ESP32-S3           │  │
│  │   (传感器层)     │◄────────────►│    (小智AI + 云端)       │  │
│  │                 │   115200bps  │                         │  │
│  │  • DHT11 温湿度  │              │  • 语音交互 (小智AI)     │  │
│  │  • MAX30102 心率 │              │  • MCP工具系统          │  │
│  │  • MPU6050 姿态  │              │  • 华为云IoT上报        │  │
│  │  • MQ2 烟雾      │              │  • OLED显示            │  │
│  │  • GPS 定位      │              │                         │  │
│  │  • 按键控制      │              │                         │  │
│  └─────────────────┘              └─────────────────────────┘  │
│                                              │                  │
│                                              ▼                  │
│                                    ┌─────────────────┐         │
│                                    │    华为云IoT    │         │
│                                    │   (数据可视化)   │         │
│                                    └─────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 已完成功能（11/11任务）

| 序号 | 任务 | 功能描述 | 状态 |
|:----:|------|----------|:----:|
| 1 | UART通信 | DMA收发 + RingBuffer + JSON命令解析 | ✅ |
| 2 | LED指示 | 事件驱动 + 软件定时器（心跳/错误/忙碌） | ✅ |
| 3 | OLED显示 | 软件I2C + 6界面切换（欢迎/DHT11/MQ2/MPU/MAX/GPS） | ✅ |
| 4 | 按键控制 | GPIO中断 + 去抖 + 界面联动控制 | ✅ |
| 5 | DHT11 | 单总线 + 温湿度采集 | ✅ |
| 6 | MQ2 | ADC DMA + PPM计算 + 5级报警 | ✅ |
| 7 | MPU6050 | 硬件I2C + DMP姿态 + 计步 + 摔倒/碰撞检测 | ✅ |
| 8 | MAX30102 | 硬件I2C + 心率血氧 + Maxim算法 | ✅ |
| 9 | GPS | UART2 DMA + NMEA解析 + 经纬度 | ✅ |
| 10 | ESP32通信 | UART3 DMA + 协议收发 + 远程控制 | ✅ |
| 11 | **华为云IoT** | **MQTT上报 + 定时/事件触发 + 数据同步** | ✅ **NEW** |

---

## 华为云IoT功能

### 上报数据

| 数据项 | 来源 | 说明 |
|--------|------|------|
| Longitude | GPS | 经度 |
| Latitude | GPS | 纬度 |
| Temperature | DHT11 | 温度(°C) |
| Humidity | DHT11 | 湿度(%) |
| HeartRate | MAX30102 | 心率(bpm) |
| BloodOxygen | MAX30102 | 血氧(%) |
| FallFlag | MPU6050 | 摔倒标志 |
| CollisionFlag | MPU6050 | 碰撞标志 |

### 上报机制

| 触发方式 | 间隔 | 说明 |
|----------|------|------|
| 定时上报 | 30秒 | 周期性上报所有传感器数据 |
| 事件上报 | 立即 | 摔倒/碰撞检测到时立即上报 |

### 连接参数

```
Broker:   00a64b9e07.st1.iotda-device.cn-south-1.myhuaweicloud.com
Port:     8883 (MQTTS/TLS)
DeviceID: 695cb5e3c9429d337f25cf62_smart_helmat_ai
Topic:    $oc/devices/{device_id}/sys/properties/report
```

---

## 关键文件

| 文件 | 说明 |
|------|------|
| `ESP32_XiaoZhi/main/boards/common/huaweicloud_iot.h` | 华为云IoT模块 |
| `ESP32_XiaoZhi/main/boards/common/stm32_controller.h` | STM32通信+数据同步 |

---

## 待优化

1. **动态密码计算** - 当前使用固定HMAC签名，建议实现动态计算
2. **功耗优化** - 低功耗模式未实现
3. **断线重连优化** - 增加指数退避重连策略

---

## 内存使用

| 模块 | 大小 |
|------|------|
| FreeRTOS堆 | 20KB |
| 总任务栈 | ~15KB |
| ESP32空闲SRAM | ~96KB |

---

## 文档位置

| 文档 | 路径 |
|------|------|
| 各传感器技术文档 | `Markdown/` 目录 |
| **华为云上云教程** | `Markdown/华为云IoT上云详解.md` |

---

> 最后更新: 2026-01-06 by Claude Code
