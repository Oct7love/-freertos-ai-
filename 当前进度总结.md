# FreeRTOS项目进度 - 快速恢复手册

> 更新：2026-01-04 | 项目：freertos_test | GitHub: https://github.com/Oct7love/-freertos-ai-
> 最新：MAX30102心率血氧传感器任务完成（含官方算法优化）

---

## 已完成功能

### 1. UART任务（优先级3）
- DMA收发 + RingBuffer(2KB) + UTF-8边界检测
- 命令解析：`error` → LED错误模式，`normal` → LED心跳
- **修复：** 多任务打印冲突 → vsnprintf移入Mutex保护内

### 2. LED任务（优先级2）
- 事件驱动 + 软件定时器
- 模式：心跳500ms / 错误100ms / 忙碌常亮
- **修复：** portMAX_DELAY死锁 → 改为0超时
- **注意：** 高报警时自动触发快闪

### 3. OLED任务（优先级2）
- 软件I2C（PB4=SCL, PB5=SDA）
- 消息队列 + 互斥锁保护
- **多界面切换：** 欢迎页 → DHT11界面 → MQ2界面 → MPU6050界面 → MAX30102界面
- **接口：** `oled_update_dht11()`, `oled_update_mq2()`, `oled_update_mpu6050()`, `oled_update_max30102()`, `oled_get_current_page()`
- 刷新：定期200ms自动刷新

### 4. 按键任务（优先级3）
- GPIO中断（PC8=KEY1, PC9=KEY2）
- 软件定时器去抖30ms + 事件组通知
- **KEY1：** 根据当前界面启停对应传感器（DHT11/MQ2/MPU6050/MAX30102）
- **KEY2：** 循环切换界面（欢迎页→DHT11→MQ2→MPU6050→MAX30102→欢迎页）

### 5. DHT11任务（优先级2）
- 单总线通信（PA8），2秒采样周期
- Mutex保护共享数据 + 临界区保护时序
- 支持挂起/恢复：`dht11_task_start()`, `dht11_task_stop()`
- **文档：** `Markdown/DHT11温湿度传感器FreeRTOS移植技术文档.md`

### 6. MQ2任务（优先级2）
- ADC DMA循环采样（PA0/ADC1_IN0），30次均值滤波
- PPM计算 + 5级报警（安全/低/中/高/危险）
- Mutex保护共享数据，支持挂起/恢复
- **文档：** `Markdown/MQ2气体传感器FreeRTOS移植技术文档.md`

### 7. MPU6050任务（优先级2）
- 硬件I2C1（PB6=SCL, PB7=SDA），DMP姿态解算
- 功能：三轴姿态（Pitch/Roll/Yaw）+ 计步器 + 摔倒检测
- 100ms采样周期，Mutex保护共享数据
- 支持挂起/恢复：`mpu6050_task_start()`, `mpu6050_task_stop()`
- **文档：** `Markdown/MPU6050六轴传感器DMP移植技术文档.md`

### 8. MAX30102任务（优先级2）
- 硬件I2C2（PB10=SCL, PB11=SDA），心率血氧检测
- 功能：心率检测（BPM）+ 血氧饱和度（SpO2）+ 手指检测 + 温度读取
- 10ms采样周期（100Hz），Mutex保护共享数据
- **算法：** Maxim官方算法 - DC滤波 + hysteresis峰值检测 + SpO2查表法
- 支持挂起/恢复：`max30102_task_start()`, `max30102_task_stop()`
- **修复：** 堆溢出（12KB→17KB） + 栈溢出（512→1024） + 手指检测消抖 + armed状态修复
- **文档：** `Markdown/MAX30102心率血氧传感器FreeRTOS移植技术文档.md`

### 9. 文档
- `Markdown/LED定时器死锁问题调试报告.md`
- `Markdown/OLED和按键移植文档.md`
- `Markdown/DHT11温湿度传感器FreeRTOS移植技术文档.md`
- `Markdown/MQ2气体传感器FreeRTOS移植技术文档.md`
- `Markdown/MPU6050六轴传感器DMP移植技术文档.md`
- `Markdown/MAX30102心率血氧传感器FreeRTOS移植技术文档.md`
- `当前进度总结.md`

---

## 任务优先级与IPC

```
优先级4：ESP32通信（预留）
优先级3：uart_rx_task, key_task
优先级2：oled_task, dht11_task, mq2_task, mpu6050_task, max30102_task, led_task

IPC机制：
- 队列：oled_queue（显示命令）
- 事件组：key_event_group（按键事件）
- 互斥锁：
  - oled_mutex（I2C+缓冲区）
  - uart_tx_mutex（串口发送）
  - dht11_mutex（温湿度数据）
  - mq2_mutex（气体浓度数据）
  - mpu6050_mutex（姿态数据）
  - max30102_mutex（心率血氧数据）
- 定时器：key1/2_debounce_timer（去抖）
```

---

## 文件结构

```
Core/
├── APP/
│   ├── bsp_system.h      # 统一头文件（注意包含顺序！）
│   └── scheduler_task.c  # 任务初始化调度
├── task/
│   ├── uart_task.c/h
│   ├── led_task.c/h
│   ├── oled_task.c/h     # 多界面支持（5个界面）
│   ├── key_task.c/h      # 界面联动按键
│   ├── dht11_task.c/h
│   ├── mq2_task.c/h
│   ├── mpu6050_task.c/h
│   ├── max30102_task.c/h # 心率血氧任务
│   └── driver/
│       ├── oled.c/h
│       ├── oledfont.c/h
│       ├── delay.c/h     # TIM3微秒延时
│       ├── dht11.c/h
│       ├── mq2.c/h
│       └── eMPL_MPU/     # DMP库
│           ├── inv_mpu.c/h
│           ├── inv_mpu_dmp_motion_driver.c/h
│           ├── dmpKey.h
│           └── dmpmap.h
├── Inc/
│   ├── adc.h
│   ├── i2c.h             # I2C1+I2C2配置
│   └── tim.h
└── Src/
    ├── adc.c             # ADC1 DMA配置
    ├── i2c.c             # I2C1(MPU6050)+I2C2(MAX30102)配置
    └── tim.c             # TIM3微秒延时
```

---

## 关键代码速查

### 错峰启动
```c
uart: 0ms, led: 50ms, key: 100ms, oled: 150ms, dht11: 250ms, mq2: 300ms, mpu6050: 400ms, max30102: 450ms
```

### 传感器控制接口
```c
// DHT11
void dht11_task_start(void);
void dht11_task_stop(void);
uint8_t dht11_is_running(void);
void dht11_get_data(uint8_t *temp, uint8_t *humi, uint8_t *valid);

// MQ2
void mq2_task_start(void);
void mq2_task_stop(void);
uint8_t mq2_is_running(void);
void mq2_get_data(float *ppm, MQ2_AlarmLevel_t *alarm, uint8_t *valid);

// MPU6050
void mpu6050_task_start(void);
void mpu6050_task_stop(void);
uint8_t mpu6050_is_running(void);
void mpu6050_get_attitude(float *pitch, float *roll, float *yaw, uint8_t *valid);
void mpu6050_get_step_data(uint32_t *steps, float *distance);
uint8_t mpu6050_is_fall_detected(void);

// MAX30102
void max30102_task_start(void);
void max30102_task_stop(void);
uint8_t max30102_is_running(void);
void max30102_get_data(uint16_t *heart_rate, uint8_t *spo2, uint8_t *valid);
void max30102_get_full_data(MAX30102_Data_t *data);
uint8_t max30102_is_finger_detected(void);
MAX30102_HR_Status_t max30102_get_hr_status(void);
float max30102_read_temperature(void);
```

### OLED界面枚举
```c
typedef enum {
    UI_PAGE_WELCOME = 0,  // 欢迎页
    UI_PAGE_DHT11,        // 温湿度界面
    UI_PAGE_MQ2,          // 气体浓度界面
    UI_PAGE_MPU6050,      // 姿态传感器界面
    UI_PAGE_MAX30102,     // 心率血氧界面
    UI_PAGE_MAX
} ui_page_t;
```

---

## 重要问题记录

### 1. 多任务串口打印冲突
- **现象：** `[DHT` 和 `[MQ2]` 打印交错出现乱码 `\0tart.`
- **原因：** vsnprintf格式化在Mutex之前执行，缓冲区被覆盖
- **解决：** 将vsnprintf移入Mutex保护内部

### 2. 浮点数printf不显示
- **现象：** `V= PPM=` 数值为空
- **原因：** newlib-nano默认不支持浮点数printf
- **解决：** CMakeLists.txt添加 `-u _printf_float`

### 3. MPU6050 DMP FIFO溢出
- **现象：** 剧烈晃动时连续Read error，最终堆栈溢出
- **原因：** DMP数据产生过快，FIFO溢出
- **解决：** 偶发错误是正常的，只要成功率>70%即可

### 4. 循环依赖问题
- **现象：** `unknown type name 'MQ2_AlarmLevel_t'`
- **原因：** bsp_system.h包含顺序错误
- **解决：** driver头文件在task头文件之前包含

### 5. MAX30102堆栈溢出
- **现象：** LED快闪（FreeRTOS栈溢出检测触发）
- **原因：** 堆内存12KB不足 + 任务栈512字不足
- **解决：** 堆增至17KB + 任务栈增至1024字

### 6. MAX30102 armed状态卡死
- **现象：** `pk=0`始终不增长，`arm=0`无法重武装
- **原因：** AC信号过零后无法满足 `a < thr_lo` 条件
- **解决：** 添加过零检测重武装：`(pk.prev > 0 && ac < 0)`

### 7. MAX30102手指检测频繁reset
- **现象：** `pk`从1变回0，算法被频繁重置
- **原因：** 阈值50000太高 + 消抖30样本太短
- **解决：** 阈值降至25000 + 消抖增至50样本 + 消抖期间跳过数据

### 8. MAX30102心率偏高30-40%
- **现象：** 实际心率76-80，测量96-115
- **原因：** FIFO_CONFIG=0x5F（4次平均）使输出25Hz，但时间戳按100Hz计算
- **解决：** FIFO_CONFIG改为0x1F（无平均，100Hz输出）

---

## 硬件配置

### CubeMX配置要点
```
PA0  - ADC1_IN0（MQ2传感器）
PA8  - GPIO输出（DHT11单总线）
PB4  - GPIO输出（OLED SCL软件I2C）
PB5  - GPIO输出（OLED SDA软件I2C）
PB6  - I2C1_SCL（MPU6050硬件I2C）
PB7  - I2C1_SDA（MPU6050硬件I2C）
PB10 - I2C2_SCL（MAX30102硬件I2C）
PB11 - I2C2_SDA（MAX30102硬件I2C）
PC8  - GPIO_EXTI8（KEY1）
PC9  - GPIO_EXTI9（KEY2）
TIM3 - PSC=71, ARR=65535（1us精度延时）
ADC1 - DMA循环模式，30采样点
I2C1 - 标准模式100kHz（MPU6050）
I2C2 - 标准模式100kHz（MAX30102）
```

---

## 内存配置

```c
configTOTAL_HEAP_SIZE = 17408 (17KB)

任务栈（单位：字=4字节）：
- uart=256  (1KB)
- led=128   (512B)
- key=128   (512B)
- oled=256  (1KB)
- dht11=256 (1KB)
- mq2=384   (1.5KB，浮点运算)
- mpu6050=512 (2KB，DMP+浮点运算)
- max30102=1024 (4KB，复杂算法+浮点运算)
```

---

## 快速命令

```bash
# Git提交推送
cd "C:\Users\13615\Desktop\freertos_test"
git add . && git commit -m "说明" && git push

# 检查堆内存
size_t free = xPortGetFreeHeapSize();
uart_printf_dma(&huart1, "Heap: %u\r\n", free);
```

---

## 文件路径

- **项目：** `C:\Users\13615\Desktop\freertos_test`
- **参考：** `D:\Linux_study\smart-helmet-ai\STM32_Project`
- **文档：** `C:\Users\13615\Desktop\freertos_test\Markdown\`
- **本文件：** `C:\Users\13615\Desktop\freertos_test\当前进度总结.md`
