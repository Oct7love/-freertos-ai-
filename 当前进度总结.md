# FreeRTOS项目进度 - 快速恢复手册

> 更新：2026-01-04 | 项目：freertos_test | GitHub: https://github.com/Oct7love/-freertos-ai-

---

## 已完成功能

### 1. UART任务（优先级3）
- DMA收发 + RingBuffer(2KB) + UTF-8边界检测
- 命令解析：`error` → LED错误模式，`normal` → LED心跳

### 2. LED任务（优先级2）
- 事件驱动 + 软件定时器
- 模式：心跳500ms / 错误100ms / 忙碌常亮
- **修复：** portMAX_DELAY死锁 → 改为0超时
- **注意：** 高报警时自动触发快闪

### 3. OLED任务（优先级2）✅ 多界面支持
- 软件I2C（PB4=SCL, PB5=SDA）
- 消息队列 + 互斥锁保护
- **多界面切换：** 欢迎页 → DHT11界面 → MQ2界面
- **接口：** `oled_update_dht11()`, `oled_update_mq2()`, `oled_get_current_page()`
- 刷新：定期200ms自动刷新

### 4. 按键任务（优先级3）✅ 界面联动
- GPIO中断（PC8=KEY1, PC9=KEY2）
- 软件定时器去抖30ms + 事件组通知
- **KEY1：** 根据当前界面启停对应传感器
- **KEY2：** 循环切换界面（欢迎页→DHT11→MQ2→欢迎页）

### 5. DHT11任务（优先级2）✅
- 单总线通信（PA8），2秒采样周期
- Mutex保护共享数据 + 临界区保护时序
- 支持挂起/恢复：`dht11_task_start()`, `dht11_task_stop()`
- **文档：** `Markdown/DHT11温湿度传感器FreeRTOS移植技术文档.md`

### 6. MQ2任务（优先级2）✅ 新增
- ADC DMA循环采样（PA0/ADC1_IN0），30次均值滤波
- PPM计算 + 5级报警（安全/低/中/高/危险）
- Mutex保护共享数据，支持挂起/恢复
- **文档：** `Markdown/MQ2气体传感器FreeRTOS移植技术文档.md`

### 7. 文档
- `Markdown/LED定时器死锁问题调试报告.md`
- `Markdown/OLED和按键移植文档.md`
- `Markdown/DHT11温湿度传感器FreeRTOS移植技术文档.md`
- `Markdown/MQ2气体传感器FreeRTOS移植技术文档.md` ✅ 新增
- `当前进度总结.md`

### 8. Git
- 提交1：初次提交150文件
- 提交2：DHT11+MQ2移植，43文件，14878行新增

---

## 任务优先级与IPC

```
优先级4：ESP32通信（预留）
优先级3：uart_rx_task, key_task
优先级2：oled_task, dht11_task, mq2_task, led_task

IPC机制：
- 队列：oled_queue（显示命令）
- 事件组：key_event_group（按键事件）
- 互斥锁：
  - oled_mutex（I2C+缓冲区）
  - uart_tx_mutex（串口发送）
  - dht11_mutex（温湿度数据）
  - mq2_mutex（气体浓度数据）
- 定时器：key1/2_debounce_timer（去抖）
```

---

## 文件结构

```
Core/
├── APP/
│   ├── bsp_system.h      # 统一头文件（注意包含顺序！）
│   └── scheduler_task.c  # 任务初始化调度
├── task/
│   ├── uart_task.c/h
│   ├── led_task.c/h
│   ├── oled_task.c/h     # 多界面支持
│   ├── key_task.c/h      # 界面联动按键
│   ├── dht11_task.c/h
│   ├── mq2_task.c/h      # 新增
│   └── driver/
│       ├── oled.c/h
│       ├── oledfont.c/h
│       ├── delay.c/h     # TIM3微秒延时
│       ├── dht11.c/h
│       └── mq2.c/h       # 新增
├── Inc/
│   ├── adc.h             # 新增
│   └── tim.h             # 新增
└── Src/
    ├── adc.c             # ADC1 DMA配置
    └── tim.c             # TIM3微秒延时
```

---

## 关键代码速查

### 错峰启动
```c
uart: 0ms, led: 50ms, key: 100ms, oled: 150ms, dht11: 250ms, mq2: 300ms
```

### 传感器控制接口
```c
// DHT11
void dht11_task_start(void);
void dht11_task_stop(void);
uint8_t dht11_is_running(void);
void dht11_get_data(uint8_t *temp, uint8_t *humi, uint8_t *valid);

// MQ2
void mq2_task_start(void);
void mq2_task_stop(void);
uint8_t mq2_is_running(void);
void mq2_get_data(float *ppm, MQ2_AlarmLevel_t *alarm, uint8_t *valid);
```

### OLED界面枚举
```c
typedef enum {
    UI_PAGE_WELCOME = 0,  // 欢迎页
    UI_PAGE_DHT11,        // 温湿度界面
    UI_PAGE_MQ2,          // 气体浓度界面
    UI_PAGE_COUNT
} ui_page_t;
```

---

## 重要问题记录

### 1. 循环依赖问题（本次修复）
- **现象：** `unknown type name 'MQ2_AlarmLevel_t'`
- **原因：** bsp_system.h包含顺序错误，mq2_task.h在mq2.h之前被包含
- **解决：** 调整bsp_system.h，driver头文件在task头文件之前包含

### 2. vApplicationStackOverflowHook重复定义
- **原因：** freertos.c第70行和第139行有两个定义
- **解决：** 删除重复定义，保留一个

### 3. MQ2头文件不包含bsp_system.h
- **原因：** 避免循环依赖
- **解决：** mq2.h只包含main.h, adc.h, stdint.h, math.h

---

## 硬件配置

### CubeMX配置要点
```
PA0  - ADC1_IN0（MQ2传感器）
PA8  - GPIO输出（DHT11单总线）
PB4  - GPIO输出（OLED SCL）
PB5  - GPIO输出（OLED SDA）
PC8  - GPIO_EXTI8（KEY1）
PC9  - GPIO_EXTI9（KEY2）
TIM3 - PSC=71, ARR=65535（1us精度延时）
ADC1 - DMA循环模式，30采样点
```

---

## 内存配置

```c
configTOTAL_HEAP_SIZE = 10000 (10KB)
任务栈：uart=256, led=128, key=128, oled=256, dht11=256, mq2=384
MQ2栈较大：浮点运算需要更多栈空间
```

---

## 快速命令

```bash
# Git提交推送
cd "C:\Users\13615\Desktop\freertos_test"
git add . && git commit -m "说明" && git push

# 检查堆内存
size_t free = xPortGetFreeHeapSize();
uart_printf_dma(&huart1, "Heap: %u\r\n", free);
```

---

## 文件路径

- **项目：** `C:\Users\13615\Desktop\freertos_test`
- **参考：** `D:\Linux_study\smart-helmet-ai\STM32_Project`
- **文档：** `C:\Users\13615\Desktop\freertos_test\Markdown\`
- **本文件：** `C:\Users\13615\Desktop\freertos_test\当前进度总结.md`
