# 智能安全帽项目 - 面试指南

> 本文档用于面试准备，包含项目介绍、核心技术、常见问题及回答模板

---

## 〇、简历项目描述（优化版）

### 推荐写法（技术栈前置）

```
ESP32 + STM32 智能安全帽系统                                    2025.01 V

【技术栈】STM32F103 | ESP32-S3 | FreeRTOS | ESP-IDF | MQTT | WebSocket | 华为云IoT

● 项目概述：双MCU架构智能安全帽，STM32负责多传感器实时采集，ESP32负责语音AI交互与
  云端通信。支持语音控制传感器、实时数据上报华为云、异常事件告警。

● 核心工作：
  ◆ 【双核通信】设计STM32与ESP32的UART通信协议，采用JSON格式+边界检测解决粘包问题
  ◆ 【云端对接】基于MQTT协议实现华为云IoT接入，使用HMAC-SHA256设备鉴权，数据上报延迟<100ms
  ◆ 【语音AI】集成小智AI平台，开发MCP工具系统实现"语音→意图识别→硬件控制"全链路
  ◆ 【传感器驱动】基于STM32 HAL库编写MAX30102(I2C)、MPU6050(I2C)、DHT11、MQ2(ADC)驱动
  ◆ 【实时调度】FreeRTOS多任务架构，传感器采集、UART通信、显示刷新并行运行

● 技术亮点：
  ◆ MPU6050姿态解算采用四元数+互补滤波，实现摔倒检测算法（自由落体→冲击→静止三阶段）
  ◆ 双通道架构设计：小智AI通道(WebSocket)与华为云通道(MQTT)独立运行，互不干扰
  ◆ MCP工具注册机制，通过description字段实现中英文语音命令识别
```

### 对比你原来的问题

| 问题 | 原描述 | 优化后 |
|------|--------|--------|
| 技术栈不突出 | 埋在正文里 | **单独一行列出** |
| 动词模糊 | "成功打通"、"完成" | **设计、实现、开发** |
| 缺少量化 | 无 | **延迟<100ms、5类传感器** |
| 协议细节缺失 | "UART通信" | **JSON格式+边界检测** |
| 云端描述模糊 | "上传至华为云" | **MQTT协议+HMAC-SHA256鉴权** |

### 精简版（3行版，适合简历空间紧张）

```
ESP32 + STM32 智能安全帽系统
【技术栈】STM32F103 | ESP32-S3 | FreeRTOS | MQTT | 华为云IoT | 小智AI

双MCU架构，STM32采集5类传感器(心率/姿态/温湿度/烟雾/GPS)，通过自定义UART协议
传输至ESP32；ESP32集成小智AI语音交互，同时通过MQTT直连华为云实现数据上报与告警。
实现摔倒检测(三阶段算法)、语音控制硬件(MCP协议)、紧急事件实时上报等功能。
```

### 面试官眼中的关键词（必须出现）

```
┌─────────────────────────────────────────────────────────────────┐
│  硬件层        │  STM32F103 · ESP32-S3 · I2C · SPI · UART · ADC  │
├─────────────────────────────────────────────────────────────────┤
│  操作系统      │  FreeRTOS · 多任务 · 信号量 · 队列              │
├─────────────────────────────────────────────────────────────────┤
│  通信协议      │  MQTT · WebSocket · UART · JSON                 │
├─────────────────────────────────────────────────────────────────┤
│  云平台        │  华为云IoT · HMAC-SHA256 · 设备三元组           │
├─────────────────────────────────────────────────────────────────┤
│  AI集成        │  小智平台 · ASR · TTS · MCP协议                 │
├─────────────────────────────────────────────────────────────────┤
│  算法          │  四元数姿态解算 · 摔倒检测 · 互补滤波           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 一、项目简介

### 1.1 一句话描述

> **基于STM32+ESP32双核架构的智能安全帽，集成多传感器监测、语音AI交互、云端数据上报功能。**

### 1.2 项目背景

针对工地、矿井等危险作业环境，传统安全帽只能提供物理防护。本项目在安全帽基础上增加：
- 生命体征监测（心率、血氧）
- 环境感知（温湿度、烟雾、GPS定位）
- 姿态检测（摔倒、碰撞预警）
- **语音AI助手**（解放双手，语音控制）
- **云端监控**（远程查看工人状态）

### 1.3 系统架构图

```
                         ┌─────────────┐
                         │   华为云IoT  │ ← 数据存储/可视化
                         └──────▲──────┘
                                │ MQTT
┌───────────────────────────────┼───────────────────────────────┐
│                         ESP32-S3                              │
│  ┌─────────────┐    ┌────────┴────────┐    ┌─────────────┐   │
│  │  小智AI模块  │    │  华为云IoT模块   │    │  MCP工具    │   │
│  │  语音交互   │    │   数据上报       │    │  硬件控制   │   │
│  └──────┬──────┘    └─────────────────┘    └──────┬──────┘   │
│         │ WebSocket                               │          │
│         ▼                                         ▼          │
│    小智云服务器                              GPIO/UART       │
│   (ASR/LLM/TTS)                                  │          │
└─────────────────────────────────┬────────────────┼───────────┘
                                  │ UART           │
                                  ▼                ▼
                         ┌───────────────┐    ┌────────┐
                         │    STM32F103   │    │ 灯/风扇 │
                         │  传感器采集    │    └────────┘
                         └───────────────┘
                                  │
        ┌─────────┬───────┬───────┼───────┬─────────┐
        ▼         ▼       ▼       ▼       ▼         ▼
    MAX30102   DHT11   MPU6050   MQ2     GPS     OLED
    心率血氧   温湿度   姿态     烟雾    定位    显示
```

---

## 二、核心技术栈

### 2.1 硬件平台

| 模块 | 型号 | 作用 |
|------|------|------|
| 主控1 | STM32F103C8T6 | 传感器采集、实时控制 |
| 主控2 | ESP32-S3 | WiFi通信、语音AI、云连接 |
| 心率血氧 | MAX30102 | I2C接口，PPG光电检测 |
| 温湿度 | DHT11 | 单总线协议 |
| 姿态 | MPU6050 | I2C，6轴加速度+陀螺仪 |
| 烟雾 | MQ2 | ADC模拟量采集 |
| 定位 | GPS模块 | UART，NMEA协议 |
| 显示 | 0.96" OLED | I2C，SSD1306驱动 |
| 音频 | INMP441 + MAX98357 | I2S数字麦克风+功放 |

### 2.2 软件技术

| 技术领域 | 具体技术 | 说明 |
|----------|----------|------|
| **RTOS** | FreeRTOS | 多任务调度、信号量、队列 |
| **通信协议** | UART/I2C/SPI/I2S | 多种外设通信 |
| **网络协议** | MQTT/WebSocket | 云端通信 |
| **音频处理** | Opus编解码/AFE降噪 | 语音压缩与增强 |
| **AI交互** | 小智AI平台 | ASR语音识别+LLM+TTS语音合成 |
| **IoT平台** | 华为云IoT | 设备接入、数据存储、规则引擎 |
| **嵌入式框架** | ESP-IDF | 乐鑫官方开发框架 |

### 2.3 核心技术点（面试重点）

```
┌────────────────────────────────────────────────────────────┐
│                    五大核心技术点                           │
├────────────────────────────────────────────────────────────┤
│  1. FreeRTOS多任务架构 - 传感器采集与通信并行              │
│  2. 双MCU协同通信 - STM32与ESP32的UART协议设计            │
│  3. 华为云IoT接入 - MQTT协议、设备鉴权、数据上报          │
│  4. 语音AI集成 - 小智平台MCP工具系统                      │
│  5. 多传感器融合 - 摔倒检测算法、异常事件处理             │
└────────────────────────────────────────────────────────────┘
```

---

## 三、面试常见问题

### Q1: 请介绍一下你的项目

> **回答模板**（30秒版）：
>
> 这是一个**智能安全帽**项目，采用**STM32+ESP32双核架构**。
>
> STM32负责**传感器采集**，包括心率、温湿度、姿态、烟雾、GPS五类传感器；
>
> ESP32负责**通信和AI**，一方面连接**小智AI平台**实现语音交互，另一方面通过**MQTT直连华为云**上报数据。
>
> 整个系统基于**FreeRTOS**实现多任务并行，支持摔倒检测、烟雾报警等紧急事件处理。

---

### Q2: 为什么用双MCU架构？

> **回答**：
>
> 主要考虑**职责分离**和**实时性**：
>
> 1. **STM32擅长实时控制**：传感器采集需要精确时序，STM32的硬件定时器和中断响应更可靠
>
> 2. **ESP32擅长通信**：内置WiFi/蓝牙，运行小智AI固件，处理复杂的网络协议
>
> 3. **解耦设计**：传感器采集和网络通信互不干扰，一方出问题不影响另一方
>
> 4. **开发效率**：可以**并行开发**，STM32用Keil，ESP32用ESP-IDF

---

### Q3: 数据是怎么上传到华为云的？

> **回答**：
>
> 数据上传走的是**独立的MQTT通道**，不经过小智平台：
>
> ```
> STM32 --UART--> ESP32 --MQTT--> 华为云IoT
> ```
>
> 具体流程：
> 1. STM32采集数据，通过UART发送JSON格式：`{DATA:HR:75,SPO2:98}`
> 2. ESP32的`STM32Controller`解析数据，更新内部变量
> 3. `HuaweiCloudIoT`模块组装符合华为云格式的JSON
> 4. 通过MQTT协议Publish到华为云Topic
>
> **连接鉴权**使用设备三元组 + HMAC-SHA256计算密码。

---

### Q4: 小智平台在项目里起什么作用？

> **回答**：
>
> 小智平台提供**语音AI能力**，和华为云是**两条独立通道**：
>
> | 通道 | 协议 | 用途 |
> |------|------|------|
> | 小智通道 | WebSocket | 语音识别→AI对话→语音合成 |
> | 华为云通道 | MQTT | 传感器数据上报存储 |
>
> 小智平台的价值：
> - 用户说"打开心率检测" → AI识别意图 → 调用MCP工具 → 控制硬件
> - 用户说"心率多少" → AI调用查询工具 → 返回实时数据 → 语音播报
>
> **一句话总结**：小智负责"听"和"说"，华为云负责"存"。

---

### Q5: MCP工具系统是什么？

> **回答**：
>
> MCP（Model Context Protocol）是小智平台的**AI调用硬件**机制：
>
> ```
> 用户语音 → 小智云ASR → LLM分析意图 → 生成MCP调用
>                                          ↓
> 硬件执行 ← ESP32回调函数 ← McpServer解析 ← WebSocket下发
> ```
>
> 我在ESP32端**注册了20+个MCP工具**，例如：
>
> ```cpp
> mcp_server.AddTool("self.stm32.heart_rate.start",
>     "打开心率检测。当用户说'打开心率'、'测心率'时调用",
>     PropertyList(),
>     [this](const PropertyList&) {
>         SendCommand("{CMD:HR_START}\r\n");  // 发给STM32
>         return true;
>     });
> ```
>
> 关键点：**description字段**要写中英文关键词，LLM靠这个判断调用哪个工具。

---

### Q6: FreeRTOS在项目里怎么用的？

> **回答**：
>
> STM32端使用FreeRTOS管理多个任务：
>
> | 任务 | 优先级 | 功能 |
> |------|--------|------|
> | Sensor_Task | 高 | 传感器轮询采集 |
> | UART_Task | 高 | 与ESP32通信 |
> | Display_Task | 中 | OLED显示刷新 |
> | Alert_Task | 最高 | 紧急事件处理 |
>
> 使用的RTOS特性：
> - **任务通知**：传感器数据就绪通知显示任务
> - **队列**：UART接收数据缓冲
> - **信号量**：I2C总线互斥访问
> - **软件定时器**：周期性数据上报

---

### Q7: 摔倒检测是怎么实现的？

> **回答**：
>
> 基于MPU6050的**加速度突变检测**：
>
> ```c
> // 简化算法
> float acc_magnitude = sqrt(ax*ax + ay*ay + az*az);
>
> // 1. 检测自由落体（加速度接近0）
> if (acc_magnitude < 0.3g) {
>     fall_stage = FALLING;
> }
>
> // 2. 检测撞击（加速度突然变大）
> if (fall_stage == FALLING && acc_magnitude > 2.5g) {
>     fall_stage = IMPACT;
> }
>
> // 3. 检测静止（确认摔倒）
> if (fall_stage == IMPACT && 姿态角度变化大) {
>     trigger_fall_alert();
> }
> ```
>
> 检测到摔倒后：
> 1. STM32发送`{EVENT:FALL}`给ESP32
> 2. ESP32显示警告、播放警报音
> 3. 立即上报华为云，触发云端告警规则

---

### Q8: 遇到过什么技术难点？

> **回答示例1 - UART数据粘包**：
>
> 问题：STM32发送的JSON数据在ESP32端经常接收不完整或粘连
>
> 解决：设计了**行缓冲机制**，以`{`开始、`}`结束作为消息边界
> ```cpp
> if (c == '{') line_pos_ = 0;  // 新消息开始
> if (c == '}') ProcessResponse(line_buffer_);  // 消息完整
> ```

> **回答示例2 - MCP工具不响应中文**：
>
> 问题：说"开灯"没反应，说"turn on light"才行
>
> 原因：工具description只写了英文，LLM无法匹配中文意图
>
> 解决：在description中加入中文关键词
> ```cpp
> "MUST call when user says: '开灯', '打开灯', 'turn on light'"
> ```

---

## 四、技术亮点总结

面试时可以主动提及的**加分项**：

| 亮点 | 说明 |
|------|------|
| 双通道架构 | 小智AI + 华为云独立运行，互不干扰 |
| MCP工具系统 | 深入理解AI与嵌入式的结合方式 |
| 协议设计 | 自定义UART协议，解决粘包问题 |
| 异常处理 | 摔倒/碰撞/烟雾多级报警机制 |
| 模块化设计 | Board抽象层支持多开发板 |

---

## 五、项目数据（量化成果）

> 面试喜欢**量化数据**，可以提及：

- 集成 **5类传感器**，采集 **8种数据**
- 注册 **20+ MCP工具**，支持语音控制
- UART通信速率 **115200bps**，数据延迟 **<100ms**
- 华为云上报周期 **30秒**，紧急事件 **实时上报**
- 代码量：STM32端 **~3000行**，ESP32端 **~500行**（自定义部分）

---

> 文档版本: v1.0
> 更新时间: 2025年1月
