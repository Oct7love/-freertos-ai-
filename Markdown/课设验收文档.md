# 智能安全帽系统 - 课设验收文档

> 项目名称：基于STM32+ESP32双核架构的智能安全帽系统
> 技术栈：STM32F103 | ESP32-S3 | FreeRTOS | ESP-IDF | MQTT | 华为云IoT | 小智AI
> 完成日期：2026年1月

---

## 一、项目功能概述

### 1.1 系统架构

```
                         ┌─────────────┐
                         │   华为云IoT  │ ← 数据存储/可视化/告警
                         └──────▲──────┘
                                │ MQTT
┌───────────────────────────────┼───────────────────────────────┐
│                         ESP32-S3                              │
│  ┌─────────────┐    ┌────────┴────────┐    ┌─────────────┐   │
│  │  小智AI模块  │    │  华为云IoT模块   │    │  MCP工具    │   │
│  │  语音交互   │    │   数据上报       │    │  硬件控制   │   │
│  └──────┬──────┘    └─────────────────┘    └──────┬──────┘   │
│         │ WebSocket                               │          │
│         ▼                                         ▼          │
│    小智云服务器                              GPIO/UART       │
│   (ASR/LLM/TTS)                                  │          │
└─────────────────────────────────┬────────────────┼───────────┘
                                  │ UART           │
                                  ▼                ▼
                         ┌───────────────┐    ┌────────┐
                         │    STM32F103   │    │ 灯/风扇 │
                         │  传感器采集    │    └────────┘
                         └───────────────┘
                                  │
        ┌─────────┬───────┬───────┼───────┬─────────┐
        ▼         ▼       ▼       ▼       ▼         ▼
    MAX30102   DHT11   MPU6050   MQ2     GPS     OLED
    心率血氧   温湿度   姿态     烟雾    定位    显示
```

### 1.2 实现的功能列表

| 功能模块 | 具体功能 | 实现状态 |
|----------|----------|:--------:|
| **心率血氧监测** | MAX30102传感器采集，PPG算法计算心率/SpO2 | ✅ |
| **温湿度监测** | DHT11单总线协议采集环境温湿度 | ✅ |
| **姿态检测** | MPU6050 DMP姿态解算，摔倒/碰撞检测 | ✅ |
| **烟雾检测** | MQ2 ADC采集，烟雾浓度报警 | ✅ |
| **GPS定位** | NMEA协议解析，实时位置获取 | ✅ |
| **OLED显示** | 多页面显示，实时数据刷新 | ✅ |
| **按键控制** | 软件去抖，传感器启停控制 | ✅ |
| **LED指示** | 心跳/错误/忙碌多模式指示 | ✅ |
| **语音AI交互** | 小智平台集成，语音控制硬件 | ✅ |
| **云端数据上报** | 华为云IoT MQTT直连，实时上报 | ✅ |
| **紧急事件告警** | 摔倒/烟雾异常实时上报云端 | ✅ |

### 1.3 数据流向

```
传感器采集 → FreeRTOS任务处理 → UART发送ESP32 → 双通道上报
                                      │
                    ┌─────────────────┴─────────────────┐
                    ▼                                   ▼
              小智AI通道                          华为云通道
            (WebSocket)                           (MQTT)
                    │                                   │
                    ▼                                   ▼
              语音交互/控制                      数据存储/可视化
```

---

## 二、项目亮点

### 2.1 双MCU架构设计

**设计理念：职责分离，各司其职**

| MCU | 职责 | 优势 |
|-----|------|------|
| STM32F103 | 传感器实时采集、硬件控制 | 硬件定时器精确、中断响应快 |
| ESP32-S3 | WiFi通信、语音AI、云连接 | 内置WiFi/蓝牙、算力强 |

**优点：**
- 传感器采集和网络通信互不干扰
- 一方出问题不影响另一方
- 可并行开发，提高效率

### 2.2 FreeRTOS多任务架构

**任务设计：**

| 任务 | 优先级 | 栈大小 | 功能 |
|------|:------:|:------:|------|
| uart_rx_task | 3 | 512字 | UART接收处理 |
| key_task | 3 | 128字 | 按键事件处理 |
| dht11_task | 2 | 256字 | 温湿度采集 |
| mpu6050_task | 2 | 512字 | 姿态采集 |
| max30102_task | 2 | 1024字 | 心率血氧采集 |
| mq2_task | 2 | 384字 | 烟雾采集 |
| gps_task | 2 | 512字 | GPS解析 |
| oled_task | 2 | 256字 | 显示刷新 |
| esp32_task | 2 | 512字 | ESP32通信 |

**IPC机制使用：**
- **Mutex**：保护共享数据（dht11_mutex, max30102_mutex等）
- **Queue**：OLED显示命令队列（解耦生产者消费者）
- **Event Group**：按键事件通知、LED模式切换
- **Binary Semaphore**：UART DMA完成通知

### 2.3 双通道云端架构

**创新点：小智AI通道与华为云通道独立运行**

```
┌─────────────────────────────────────────────────────────┐
│                    ESP32-S3 双通道架构                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   ┌─────────────────┐       ┌─────────────────┐        │
│   │   小智AI通道     │       │   华为云通道     │        │
│   │   (WebSocket)   │       │    (MQTT)       │        │
│   ├─────────────────┤       ├─────────────────┤        │
│   │ • 语音识别(ASR) │       │ • 数据上报      │        │
│   │ • AI对话(LLM)   │       │ • 设备鉴权      │        │
│   │ • 语音合成(TTS) │       │ • 告警推送      │        │
│   │ • MCP工具调用   │       │ • 远程监控      │        │
│   └─────────────────┘       └─────────────────┘        │
│                                                         │
│   一句话总结：小智负责"听"和"说"，华为云负责"存"        │
└─────────────────────────────────────────────────────────┘
```

### 2.4 MCP工具系统

**实现语音→意图识别→硬件控制全链路：**

```cpp
// 注册MCP工具示例
mcp_server.AddTool("self.stm32.heart_rate.start",
    "打开心率检测。当用户说'打开心率'、'测心率'时调用",
    PropertyList(),
    [this](const PropertyList&) {
        SendCommand("{CMD:HR_START}\r\n");
        return true;
    });
```

**关键技术点：**
- description字段包含中英文关键词，LLM靠此判断调用哪个工具
- 注册20+个MCP工具，覆盖所有传感器控制

### 2.5 心率血氧算法

**自研PPG信号处理算法：**

1. **DC滤波**：IIR低通滤波提取AC分量
2. **峰值检测**：Hysteresis机制，动态阈值+过零重武装
3. **心率计算**：峰间隔平均+IIR平滑
4. **血氧计算**：Maxim官方查表法

```
原始数据 → DC滤波 → AC低通 → 峰值检测(Hysteresis) → 心率/SpO2计算
```

### 2.6 临界区保护机制

**解决DHT11在FreeRTOS下高失败率问题：**

```c
// 时序敏感部分禁用中断
taskENTER_CRITICAL();
DHT11_CheckResponse();
for (i = 0; i < 5; i++) {
    data[i] = DHT11_ReadByte();
}
taskEXIT_CRITICAL();
```

**效果：** 成功率从13%提升到96%

---

## 三、项目难点与解决方案

### 3.1 难点1：DHT11在FreeRTOS下读取失败率高

**问题现象：**
- 裸机正常，FreeRTOS下失败率80-90%
- 即使禁用其他任务仍有10%失败率

**根本原因：**
- DHT11时序要求微秒级精度（26us vs 70us区分0/1）
- SysTick中断每1ms触发，打断采样时序

**解决方案：**
```c
// 在时序敏感部分使用临界区保护
taskENTER_CRITICAL();  // 禁用中断
// 响应检测 + 数据读取（约5ms）
taskEXIT_CRITICAL();   // 恢复中断
```

**经验总结：**
- 临界区时间控制在10ms以内
- 只保护必须保护的部分，起始信号20ms不保护

### 3.2 难点2：MAX30102心率始终为0

**问题现象：**
- 日志显示`arm=0 pk=0 hr=0`
- 峰值计数不增长

**根本原因：**
- 峰值检测后`armed=0`
- AC信号围绕0波动，无法满足`a < thr_lo`条件重武装

**解决方案：**
```c
// 添加过零检测重武装
if (a < thr_lo || (pk.prev > 0 && ac < 0) || (pk.prev < 0 && ac > 0)) {
    pk.armed = 1;  // AC过零时也重武装
}
```

### 3.3 难点3：MAX30102心率偏高30-40%

**问题现象：**
- 实际心率76-80 BPM，测量值96-115 BPM

**根本原因：**
- FIFO_CONFIG = 0x5F（4次平均）
- 实际输出25Hz，但代码按100Hz计算时间戳

**解决方案：**
```c
// 禁用FIFO平均
max30102_write_reg(MAX30102_REG_FIFO_CONFIG, 0x1F);  // 无平均
```

### 3.4 难点4：UART数据粘包/分片

**问题现象：**
- STM32发送的JSON在ESP32端接收不完整或粘连

**解决方案：**
```cpp
// 行缓冲机制，以{开始、}结束作为消息边界
if (c == '{') line_pos_ = 0;  // 新消息开始
if (c == '}') ProcessResponse(line_buffer_);  // 消息完整
```

### 3.5 难点5：MCP工具不响应中文

**问题现象：**
- 说"开灯"没反应，说"turn on light"才行

**根本原因：**
- 工具description只写了英文，LLM无法匹配中文意图

**解决方案：**
```cpp
// 在description中加入中文关键词
"MUST call when user says: '开灯', '打开灯', 'turn on light'"
```

### 3.6 难点6：堆栈溢出（LED快闪）

**问题现象：**
- 系统启动后LED快速闪烁
- FreeRTOS栈溢出检测钩子被触发

**解决方案：**
```c
// 增加堆内存
#define configTOTAL_HEAP_SIZE  ((size_t)17408)  // 12KB → 17KB

// 增加任务栈
xTaskCreate(max30102_task, "max30102", 1024, NULL, 2, &handle);
// 栈从512 → 1024字
```

---

## 四、通信协议总结

### 4.1 I2C协议

**本项目使用情况：**

| 设备 | I2C总线 | 地址 | 速率 |
|------|---------|------|------|
| MAX30102 | I2C2 | 0xAE | 100kHz |
| MPU6050 | I2C1 | 0xD0 | 400kHz |
| OLED SSD1306 | I2C1 | 0x78 | 400kHz |

**I2C协议要点：**

```
起始条件 → 设备地址(7bit) + R/W(1bit) → ACK → 数据 → ACK → 停止条件

时序特点：
• SCL为高时，SDA下降沿 = 起始条件
• SCL为高时，SDA上升沿 = 停止条件
• 数据在SCL高电平期间稳定，SCL低电平期间变化

HAL库使用：
HAL_I2C_Mem_Write(&hi2c, addr, reg, I2C_MEMADD_SIZE_8BIT, &data, 1, timeout);
HAL_I2C_Mem_Read(&hi2c, addr, reg, I2C_MEMADD_SIZE_8BIT, &data, 1, timeout);
```

**I2C常见问题：**
- 上拉电阻：需要4.7kΩ上拉（模块通常内置）
- 地址冲突：同一总线设备地址不能重复
- 总线死锁：SDA被拉低无法释放，需要时钟恢复

### 4.2 SPI协议

**本项目未使用SPI，但掌握原理：**

```
SPI四线制：
• SCLK：时钟线（主机产生）
• MOSI：主出从入（Master Out Slave In）
• MISO：主入从出（Master In Slave Out）
• CS/SS：片选（低电平有效）

四种模式（CPOL/CPHA）：
• Mode 0：CPOL=0, CPHA=0（空闲低，第一边沿采样）
• Mode 1：CPOL=0, CPHA=1（空闲低，第二边沿采样）
• Mode 2：CPOL=1, CPHA=0（空闲高，第一边沿采样）
• Mode 3：CPOL=1, CPHA=1（空闲高，第二边沿采样）

优点：全双工、速度快（可达几十MHz）
缺点：引脚多、无应答机制
```

**典型应用：**
- Flash存储器（W25Q系列）
- LCD显示屏（SPI接口）
- SD卡（SPI模式）

### 4.3 UART协议

**本项目使用情况：**

| 串口 | 用途 | 波特率 | 模式 |
|------|------|--------|------|
| USART1 | 调试打印 | 115200 | DMA |
| USART2 | GPS模块 | 9600 | DMA |
| USART3 | ESP32通信 | 115200 | DMA |

**UART协议要点：**

```
帧格式：起始位(1) + 数据位(8) + 校验位(0/1) + 停止位(1/2)

波特率计算（STM32）：
BRR = PCLK / (16 × BaudRate)

DMA收发优势：
• 不占用CPU，后台传输
• 适合大数据量传输
• 配合空闲中断实现不定长接收
```

**本项目UART设计：**
```c
// DMA发送 + 互斥锁保护
xSemaphoreTake(uart_tx_mutex, portMAX_DELAY);
HAL_UART_Transmit_DMA(&huart, buffer, len);
xSemaphoreTake(uart_tx_done, timeout);  // 等待完成
xSemaphoreGive(uart_tx_mutex);

// DMA接收 + 空闲中断
__HAL_UART_ENABLE_IT(&huart, UART_IT_IDLE);
HAL_UARTEx_ReceiveToIdle_DMA(&huart, buffer, size);
```

### 4.4 CAN协议

**本项目未使用CAN，但掌握原理：**

```
CAN总线特点：
• 差分信号：CAN_H和CAN_L，抗干扰强
• 多主结构：任意节点可主动发送
• 非破坏性仲裁：ID小的优先级高
• 错误检测：CRC校验、位填充、帧检查

帧类型：
• 数据帧：传输数据（0-8字节）
• 远程帧：请求数据
• 错误帧：检测到错误时发送
• 过载帧：请求延迟

波特率：最高1Mbps（经典CAN），5Mbps（CAN FD）

典型应用：
• 汽车电子（OBD诊断）
• 工业控制（CANopen）
• 医疗设备
```

### 4.5 单总线协议（DHT11）

**本项目使用情况：**

```
DHT11单总线时序：
1. 主机拉低≥18ms → 拉高20-40us → 切换输入
2. DHT11响应：拉低80us → 拉高80us
3. 数据传输：
   • 数据"0"：50us低 + 26-28us高
   • 数据"1"：50us低 + 70us高
4. 40位数据：湿度整数+小数 + 温度整数+小数 + 校验和

关键点：
• GPIO需要动态切换输入/输出模式
• 时序要求微秒级精度
• FreeRTOS下需要临界区保护
```

---

## 五、项目量化数据

| 指标 | 数值 |
|------|------|
| 传感器数量 | 5类（心率、温湿度、姿态、烟雾、GPS） |
| 采集数据类型 | 8种（心率、血氧、温度、湿度、Pitch/Roll/Yaw、烟雾浓度、经纬度） |
| FreeRTOS任务数 | 9个 |
| IPC对象数 | 9个（Mutex×4 + Semaphore×2 + Queue×1 + EventGroup×2） |
| MCP工具数 | 20+ |
| UART通信速率 | 115200bps |
| 数据上报延迟 | <100ms |
| 华为云上报周期 | 30秒（常规）/ 实时（紧急事件） |
| STM32代码量 | ~3000行 |
| ESP32自定义代码 | ~500行 |
| 堆内存使用 | ~4.4KB / 17KB (26%) |
| CPU占用率 | ~6% |

---

## 六、技术栈总结

```
┌─────────────────────────────────────────────────────────────────┐
│  硬件层        │  STM32F103 · ESP32-S3 · I2C · SPI · UART · ADC  │
├─────────────────────────────────────────────────────────────────┤
│  操作系统      │  FreeRTOS · 多任务 · 信号量 · 队列 · 事件组     │
├─────────────────────────────────────────────────────────────────┤
│  通信协议      │  MQTT · WebSocket · UART · JSON · I2C           │
├─────────────────────────────────────────────────────────────────┤
│  云平台        │  华为云IoT · HMAC-SHA256 · 设备三元组           │
├─────────────────────────────────────────────────────────────────┤
│  AI集成        │  小智平台 · ASR · TTS · MCP协议                 │
├─────────────────────────────────────────────────────────────────┤
│  算法          │  DMP姿态解算 · PPG心率算法 · 摔倒检测           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、项目收获

### 7.1 技术能力提升

1. **嵌入式RTOS开发**：掌握FreeRTOS任务调度、IPC机制、内存管理
2. **多传感器驱动开发**：I2C/UART/单总线协议实战
3. **信号处理算法**：PPG心率算法、姿态解算
4. **物联网开发**：MQTT协议、云平台对接
5. **AI嵌入式集成**：语音交互、MCP工具系统

### 7.2 工程经验积累

1. **调试方法论**：日志分级、问题定位、根因分析
2. **架构设计**：模块化、解耦、可扩展
3. **文档习惯**：技术文档、问题记录、经验总结

---

> 文档版本：v1.0
> 生成时间：2026年1月
